<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthHelp GeoAI - Philippines Health Mapping</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            overflow: hidden;
            color: #333;
        }
        
    #header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: linear-gradient(to right, #8b0000 85%, black 85%, black 87%, transparent 87%);
        color: white;
        z-index: 1000;
        display: flex;
        align-items: center;
        padding: 0 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    /* Add a pseudo-element for the transparent white/clear area */
    #header::after {
        content: '';
        position: absolute;
        top: 15px;
        right: 40px;
        width: 40px;
        height: 40px;
        background-color: rgba(255, 255, 255, 0.2); /* Transparent white */
        border-radius: 50%;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        cursor: pointer;
    }
    
    /* Add the X mark */
    #header::before {
        content: 'âœ•';
        position: absolute;
        top: 50%;
        right: 50px;
        transform: translateY(-50%);
        color: rgba(0, 0, 0, 0.7);
        font-size: 20px;
        font-weight: bold;
        z-index: 1001;
        cursor: pointer;
    }
        
        #logo {
            height: 50px;
            margin-right: 15px;
        }
        
        #title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        #main-container {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            height: calc(100% - 70px);
            display: flex;
        }
        
        #sidebar {
            width: 350px;
            height: 100%;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 15px;
            z-index: 900;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        
        #map-container {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .panel {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            overflow: hidden;
        }
        
        .panel-header {
            background-color: #a52a2a; /* Maroon */
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-content {
            padding: 15px;
            display: none;
        }
        
        .panel.active .panel-content {
            display: block;
        }
        
        .layer-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .layer-control input {
            margin-right: 10px;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #8b0000;
        }
        
        .slider {
            width: 100%;
        }
        
        .button {
            background-color: #8b0000;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            text-align: left;
        }
        
        .button:hover {
            background-color: #a52a2a;
        }
        
        .button i {
            margin-right: 8px;
        }
        
        .toggle-sidebar {
            position: absolute;
            top: 80px;
            left: 350px;
            z-index: 950;
            background: #8b0000;
            color: white;
            border: none;
            width: 20px;
            height: 40px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 800;
            max-width: 200px;
        }
        
/* Boundary Layers Legend Enhancement */
.legend {
    background: rgba(255, 255, 255, 0.25);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 800;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(139, 0, 0, 0.15);
    max-width: 180px;
}

.legend h4 {
    margin: 0 0 10px 0;
    color: #8b0000;
    font-size: 0.95rem;
    text-align: center;
    font-weight: 600;
    border-bottom: 1px solid rgba(139, 0, 0, 0.1);
    padding-bottom: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.legend-color {
    width: 18px;
    height: 18px;
    margin-right: 8px;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

.legend-item span {
    font-size: 0.85rem;
    color: #333;
}
        
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 800;
            max-width: 300px;
            display: none;
        }
        
        .health-facility-marker {
            border-radius: 50%;
            border: 2px solid white;
        }
        
.year-slider-container {
    background: rgba(255, 255, 255, 0.25); /* More transparent */
    padding: 12px 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    position: absolute;
    bottom: 25px;
    left: 50%;
    transform: translateX(-50%); 
    z-index: 800;
    width: 65%;
    min-width: 320px;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(139, 0, 0, 0.15);
}

.year-slider-container label {
    display: block;
    text-align: center;
    margin-bottom: 8px;
    font-weight: 600;
    color: #8b0000;
    font-size: 0.9rem;
}

#timeline-slider {
    -webkit-appearance: none;
    width: 100%;
    height: 5px;
    border-radius: 5px;
    background: rgba(139, 0, 0, 0.1); /* More transparent track */
    outline: none;
    margin: 8px 0;
}

#timeline-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #8b0000;
    cursor: pointer;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8), 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

#timeline-slider::-webkit-slider-thumb:hover {
    transform: scale(1.15);
    background: #a52a2a;
}

#timeline-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #8b0000;
    cursor: pointer;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8), 0 2px 4px rgba(0, 0, 0, 0.2);
    border: none;
    transition: all 0.2s ease;
}

#timeline-slider::-moz-range-thumb:hover {
    transform: scale(1.15);
    background: #a52a2a;
}

#timeline-year {
    font-weight: bold;
    color: #8b0000;
    background: rgba(139, 0, 0, 0.1);
    padding: 2px 8px;
    border-radius: 8px;

}
        
        .upload-panel {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 150px;
            right: 20px;
            z-index: 800;
            width: 250px;
            display: none;
        }
        
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(139, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #8b0000;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .layer-status {
            font-size: 0.8rem;
            color: #666;
            margin-left: 10px;
        }
        
        .error-message {
            color: #d9534f;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .warning-message {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 5px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #8b0000;
            width: 0%;
            transition: width 0.3s ease;
        }
        /* Zoom Controls Enhancement */
.leaflet-control-zoom {
    border: 1px solid rgba(139, 0, 0, 0.15) !important;
    background: rgba(255, 255, 255, 0.25) !important;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 8px !important;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15) !important;
}

.leaflet-control-zoom a {
    background: rgba(255, 255, 255, 0.7) !important;
    border-bottom: 1px solid rgba(139, 0, 0, 0.1) !important;
    color: #8b0000 !important;
    font-weight: bold;
    transition: all 0.2s ease;
    width: 30px !important;
    height: 30px !important;
    line-height: 30px !important;
    font-size: 18px !important;
}

.leaflet-control-zoom a:hover {
    background: rgba(139, 0, 0, 0.1) !important;
}

.leaflet-control-zoom a:first-child {
    border-top-left-radius: 7px !important;
    border-top-right-radius: 7px !important;
}

.leaflet-control-zoom a:last-child {
    border-bottom: none !important;
    border-bottom-left-radius: 7px !important;
    border-bottom-right-radius: 7px !important;
}

.leaflet-control-zoom a.leaflet-disabled {
    background: rgba(255, 255, 255, 0.3) !important;
    color: rgba(139, 0, 0, 0.4) !important;
}

/* Heatmap Legend Styles */
.heatmap-legend {
    background: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    position: absolute;
    top: 100px;
    right: 20px;
    z-index: 800;
    max-width: 150px;
}

.heatmap-legend h4 {
    margin: 0 0 8px 0;
    color: #8b0000;
    font-size: 0.9rem;
    text-align: center;
}

.heatmap-gradient {
    height: 10px;
    width: 100%;
    background: linear-gradient(to right, blue, cyan, green, yellow, orange, red);
    margin-bottom: 5px;
    border-radius: 2px;
}

.heatmap-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.7rem;
    color: #333;
}
    </style>
</head>
<body>
    <div id="header">
        <img src="https://raw.githubusercontent.com/HealthHelps/geoAI/main/HealthHelpLogo.png" alt="HealthHelp Logo" id="logo">
        <h1 id="title">HealthHelp GeoAI</h1>
    </div>
    
    <div id="main-container">
        <div id="sidebar">
            <div class="panel active">
                <div class="panel-header">
                    <span>Boundary Layers</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <div class="layer-control">
                        <input type="checkbox" id="region-layer" checked>
                        <label for="region-layer">Regions</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="province-layer" checked>
                        <label for="province-layer">Provinces</label>
                        <span id="province-status" class="layer-status">Loading...</span>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="municipality-layer">
                        <label for="municipality-layer">Municipalities</label>
                        <span id="municipality-status" class="layer-status">Click to load</span>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="barangay-layer">
                        <label for="barangay-layer">Barangays</label>
                        <span id="barangay-status" class="layer-status">Click to load</span>
                    </div>
                    <div class="warning-message" id="barangay-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> Barangays data is large and may take time to load.
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="barangay-progress"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>Health Facilities</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <div class="layer-control">
                        <input type="checkbox" id="rhu-layer">
                        <label for="rhu-layer">Regional Health Units (RHUs)</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="phu-layer">
                        <label for="phu-layer">Provincial Health Units (PHUs)</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="ruralhu-layer">
                        <label for="ruralhu-layer">Rural Health Units</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="bhc-layer">
                        <label for="bhc-layer">Barangay Health Centers (BHCs)</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="lyingin-layer">
                        <label for="lyingin-layer">Lying-In Clinics</label>
                    </div>
                    
                    <div class="slider-container">
                        <label>Services Filter:</label>
                        <select id="services-filter" class="slider">
                            <option value="all">All Services</option>
                            <option value="mnch">Maternal, Newborn, and Child Health (MNCH)</option>
                            <option value="fp">Family Planning (FP)</option>
                            <option value="hiv">HIV/AIDS Health Services</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>Thematic Maps</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <button class="button" id="maternal-heatmap-btn">
                        <i class="fas fa-baby"></i> Maternal & Child Death Rate
                    </button>
                    <button class="button" id="hiv-heatmap-btn">
                        <i class="fas fa-virus"></i> HIV/AIDS Death Rate
                    </button>
                    <button class="button" id="facility-heatmap-btn">
                        <i class="fas fa-hospital"></i> Health Facility Coverage
                    </button>
                    <button class="button" id="poverty-mnch-btn">
                        <i class="fas fa-exclamation-triangle"></i> Poverty & MNCH Intersection
                    </button>
                    <button class="button" id="poverty-hiv-btn">
                        <i class="fas fa-exclamation-triangle"></i> Poverty & HIV Intersection
                    </button>
                    
                    <div class="slider-container">
                        <label for="year-slider">Year: <span id="year-value">2023</span></label>
                        <input type="range" id="year-slider" class="slider" min="2010" max="2025" value="2023" step="1">
                    </div>
                    
                    <div class="slider-container">
                        <label for="opacity-slider">Opacity: <span id="opacity-value">70</span>%</label>
                        <input type="range" id="opacity-slider" class="slider" min="0" max="100" value="70" step="1">
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>GeoAI Tools</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <button class="button" id="upload-btn">
                        <i class="fas fa-upload"></i> Upload Data
                    </button>
                    <button class="button" id="analyze-btn">
                        <i class="fas fa-chart-line"></i> Analyze Data
                    </button>
                    <button class="button" id="predict-btn">
                        <i class="fas fa-robot"></i> Predict Trends
                    </button>
                    <button class="button" id="export-btn">
                        <i class="fas fa-download"></i> Export Map
                    </button>
                </div>
            </div>
        </div>
        
        <div id="map-container">
            <div id="map"></div>
            
            <button class="toggle-sidebar" id="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="legend" id="legend">
                <h4>Boundary Layers</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #8b0000;"></div>
                    <span>Regions</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #cc0000;"></div>
                    <span>Provinces</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff4500;"></div>
                    <span>Municipalities</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>Barangays</span>
                </div>
            </div>
            
            <div class="info-panel" id="info-panel">
                <h4>Location Information</h4>
                <p>Click on the map to get information</p>
            </div>
            
            <div class="year-slider-container" id="year-slider-container">
                <label for="timeline-slider">Timeline: <span id="timeline-year">2023</span></label>
                <input type="range" id="timeline-slider" class="slider" min="2010" max="2025" value="2023" step="1">
            </div>
                      
            <div class="upload-panel" id="upload-panel">
                <h4>Upload Geospatial Data</h4>
                <input type="file" id="file-upload" accept=".shp,.geojson,.kml,.gpkg" multiple>
                <p>Supported formats: Shapefile, GeoJSON, KML</p>
                <button class="button" id="process-upload">
                    <i class="fas fa-cog"></i> Process Data
                </button>
            </div>

            <!-- Heatmap Legend -->
            <div class="heatmap-legend" id="heatmap-legend">
                <h4>Region Total Values</h4>
                <div class="heatmap-gradient"></div>
                <div class="heatmap-labels">
                    <span>Low</span>
                    <span>High</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<script>
    // Initialize the map
    const map = L.map('map', {
        center: [12.8797, 121.7740], // Philippines coordinates
        zoom: 6,
        minZoom: 5,
        maxZoom: 18,
        zoomControl: false
    });
    
    // Add zoom control to top-right
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    
    // Define basemaps
    const basemaps = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }),
        terrain: L.tileLayer('https://{s}.tile.openttopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://openttopomap.org">OpenTopoMap</a>'
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        })
    };
    
    // Add default basemap (Satellite instead of OSM)
    basemaps.satellite.addTo(map);

    // Set the initial checked state for basemaps
    // Note: The basemap selector UI has been removed but functionality remains
    // Satellite is the default basemap as per the original code
    
    // Add layer groups for boundaries
    const regionLayer = L.layerGroup().addTo(map);
    const provinceLayer = L.layerGroup();
    const municipalityLayer = L.layerGroup();
    const barangayLayer = L.layerGroup();
    
    // Store loaded layers for toggle functionality
    const loadedLayers = {
        regions: null,
        provinces: null,
        municipalities: null,
        barangays: null
    };
    
    // Function to handle GeoJSON loading errors
    function handleGeoJSONError(error, layerType) {
        console.error(`Error loading ${layerType}:`, error);
        const statusElement = document.getElementById(`${layerType}-status`);
        if (statusElement) {
            statusElement.textContent = 'Error loading';
            
            // Add error message with retry button
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `Failed to load ${layerType}. 
                <a href="#" onclick="load${layerType.charAt(0).toUpperCase() + layerType.slice(1)}(); return false;">
                    Retry
                </a>`;
            
            statusElement.parentNode.appendChild(errorDiv);
        }
        
        // Add sample data for demonstration
        if (layerType === 'region') {
            addSampleRegions();
        } else if (layerType === 'province') {
            addSampleProvinces();
        } else if (layerType === 'municipality') {
            addSampleMunicipalities();
        } else if (layerType === 'barangay') {
            addSampleBarangays();
        }
    }
    
    // Load region boundaries from GitHub with heatmap visualization
    function loadRegions() {
        // Load the GeoJSON file from GitHub
        fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Regions.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Check if data was loaded correctly
                if (!data || !data.features || data.features.length === 0) {
                    throw new Error('No features found in the GeoJSON');
                }
                
                // Find the range of TOTAL values for the heatmap
                const totalValues = data.features.map(feature => 
                    feature.properties.TOTAL ? parseFloat(feature.properties.TOTAL) : 0
                );
                const minTotal = Math.min(...totalValues);
                const maxTotal = Math.max(...totalValues);
                
                // Function to get color based on TOTAL value
                function getColorByTotal(value) {
                    if (value === 0) return '#808080'; // Gray for zero values
                    
                    // Normalize the value between 0 and 1
                    const normalized = (value - minTotal) / (maxTotal - minTotal);
                    
                    // Return a color from blue to red based on the normalized value
                    const hue = ((1 - normalized) * 240); // Blue (240) to Red (0)
                    return `hsl(${hue}, 100%, 50%)`;
                }
                
                // Style function for regions with heatmap colors
                function regionStyle(feature) {
                    const totalValue = feature.properties.TOTAL ? parseFloat(feature.properties.TOTAL) : 0;
                    return {
                        fillColor: getColorByTotal(totalValue),
                        weight: 2,
                        opacity: 1,
                        color: '#8b0000',
                        dashArray: '3',
                        fillOpacity: 0.7
                    };
                }
                
                // Create GeoJSON layer with styling
                const geoJsonLayer = L.geoJson(data, {
                    style: regionStyle,
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            let popupContent = '<div class="popup-content">';
                            popupContent += `<strong>Region:</strong> ${feature.properties.REGION || 'N/A'}<br>`;
                            popupContent += `<strong>Total Value:</strong> ${feature.properties.TOTAL || 'N/A'}<br>`;
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                    }
                });
                
                // Clear any existing layers
                regionLayer.clearLayers();
                
                // Add to region layer
                geoJsonLayer.addTo(regionLayer);
                loadedLayers.regions = geoJsonLayer;
                
                // Update the heatmap legend with the actual range
                document.querySelector('.heatmap-labels').innerHTML = `
                    <span>${minTotal.toLocaleString()}</span>
                    <span>${maxTotal.toLocaleString()}</span>
                `;
            })
            .catch(function(error) {
                handleGeoJSONError(error, 'region');
            });
    }
    
    // Load province boundaries from GitHub
    function loadProvinces() {
        const statusElement = document.getElementById('province-status');
        // Clear any previous error messages
        const errorMessages = statusElement.parentNode.querySelectorAll('.error-message');
        errorMessages.forEach(msg => msg.remove());
        
        statusElement.innerHTML = '<div class="loading-indicator"></div>';
        
        // Load the GeoJSON file from GitHub
        fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Provinces.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Check if data was loaded correctly
                if (!data || !data.features || data.features.length === 0) {
                    throw new Error('No features found in the GeoJSON');
                }
                
                // Style function for provinces
                function provinceStyle(feature) {
                    return {
                        fillColor: '#cc0000',
                        weight: 2,
                        opacity: 1,
                        color: '#8b0000',
                        dashArray: '3',
                        fillOpacity: 0.3
                    };
                }
                
                // Create GeoJSON layer with styling
                const geoJsonLayer = L.geoJson(data, {
                    style: provinceStyle,
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            let popupContent = '<div class="popup-content">';
                            for (const property in feature.properties) {
                                popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                            }
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                    }
                });
                
                // Clear any existing layers
                provinceLayer.clearLayers();
                
                // Add to province layer
                geoJsonLayer.addTo(provinceLayer);
                loadedLayers.provinces = geoJsonLayer;
                
                // Update status
                statusElement.textContent = 'Loaded';
                
                // If checkbox is checked, add to map
                if (document.getElementById('province-layer').checked) {
                    map.addLayer(provinceLayer);
                }
            })
            .catch(function(error) {
                handleGeoJSONError(error, 'province');
            });
    }
    
    // Load municipality boundaries from GitHub
    function loadMunicipalities() {
        const statusElement = document.getElementById('municipality-status');
        // Clear any previous error messages
        const errorMessages = statusElement.parentNode.querySelectorAll('.error-message');
        errorMessages.forEach(msg => msg.remove());
        
        statusElement.innerHTML = '<div class="loading-indicator"></div>';
        
        // Load the GeoJSON file from GitHub
        fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Towns.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Check if data was loaded correctly
                if (!data || !data.features || data.features.length === 0) {
                    throw new Error('No features found in the GeoJSON');
                }
                
                // Style function for municipalities
                function municipalityStyle(feature) {
                    return {
                        fillColor: '#ff4500',
                        weight: 1,
                        opacity: 0.7,
                        color: '#cc0000',
                        dashArray: '2',
                        fillOpacity: 0.2
                    };
                }
                
                // Create GeoJSON layer with styling
                const geoJsonLayer = L.geoJson(data, {
                    style: municipalityStyle,
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            let popupContent = '<div class="popup-content">';
                            for (const property in feature.properties) {
                                popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                            }
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                    }
                });
                
                // Clear any existing layers
                municipalityLayer.clearLayers();
                
                // Add to municipality layer
                geoJsonLayer.addTo(municipalityLayer);
                loadedLayers.municipalities = geoJsonLayer;
                
                // Update status
                statusElement.textContent = 'Loaded';
                
                // If checkbox is checked, add to map
                if (document.getElementById('municipality-layer').checked) {
                    map.addLayer(municipalityLayer);
                }
            })
            .catch(function(error) {
                handleGeoJSONError(error, 'municipality');
            });
    }
    
    // Load barangay boundaries from GitHub
    function loadBarangays() {
        const statusElement = document.getElementById('barangay-status');
        const warningElement = document.getElementById('barangay-warning');
        const progressElement = document.getElementById('barangay-progress');
        
        // Clear any previous error messages
        const errorMessages = statusElement.parentNode.querySelectorAll('.error-message');
        errorMessages.forEach(msg => msg.remove());
        
        // Show warning
        warningElement.style.display = 'block';
        statusElement.innerHTML = '<div class="loading-indicator"></div>';
        
        // Simulate progress (since we can't track actual download progress with fetch)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            progressElement.style.width = `${progress}%`;
            if (progress >= 100) {
                clearInterval(progressInterval);
            }
        }, 200);
        
        // Load the GeoJSON file from GitHub
        fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Barangays.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Check if data was loaded correctly
                if (!data || !data.features || data.features.length === 0) {
                    throw new Error('No features found in the GeoJSON');
                }
                
                // Clear progress interval
                clearInterval(progressInterval);
                progressElement.style.width = '100%';
                
                // Style function for barangays
                function barangayStyle(feature) {
                    return {
                        fillColor: '#ff6b6b',
                        weight: 0.5,
                        opacity: 0.5,
                        color: '#ff4500',
                        fillOpacity: 0.1
                    };
                }
                
                // Create GeoJSON layer with styling
                const geoJsonLayer = L.geoJson(data, {
                    style: barangayStyle,
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            let popupContent = '<div class="popup-content">';
                            for (const property in feature.properties) {
                                popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                            }
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                    }
                });
                
                // Clear any existing layers
                barangayLayer.clearLayers();
                
                // Add to barangay layer
                geoJsonLayer.addTo(barangayLayer);
                loadedLayers.barangays = geoJsonLayer;
                
                // Update status
                statusElement.textContent = 'Loaded';
                
                // Hide warning after a delay
                setTimeout(() => {
                    warningElement.style.display = 'none';
                }, 3000);
                
                // If checkbox is checked, add to map
                if (document.getElementById('barangay-layer').checked) {
                    map.addLayer(barangayLayer);
                }
            })
            .catch(function(error) {
                // Clear progress interval
                clearInterval(progressInterval);
                handleGeoJSONError(error, 'barangay');
            });
    }
    
    // Add sample regions for demonstration
    function addSampleRegions() {
        // This is just a fallback for demonstration purposes
        const sampleRegion = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "REGION": "National Capital Region (NCR)",
                        "TOTAL": "1500"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[120.9, 14.4], [121.2, 14.4], [121.2, 14.8], [120.9, 14.8], [120.9, 14.4]]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "REGION": "CALABARZON (Region IV-A)",
                        "TOTAL": "1200"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[120.7, 13.7], [121.8, 13.7], [121.8, 14.5], [120.7, 14.5], [120.7, 13.7]]]
                    }
                }
            ]
        };
        
        // Style function for regions
        function regionStyle(feature) {
            const totalValue = feature.properties.TOTAL ? parseFloat(feature.properties.TOTAL) : 0;
            return {
                fillColor: totalValue > 1300 ? '#ff0000' : '#00ff00',
                weight: 2,
                opacity: 1,
                color: '#8b0000',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }
        
        // Create GeoJSON layer with styling
        const geoJsonLayer = L.geoJson(sampleRegion, {
            style: regionStyle,
            onEachFeature: function(feature, layer) {
                if (feature.properties) {
                    let popupContent = '<div class="popup-content">';
                    popupContent += `<strong>Region:</strong> ${feature.properties.REGION || 'N/A'}<br>`;
                    popupContent += `<strong>Total Value:</strong> ${feature.properties.TOTAL || 'N/A'}<br>`;
                    popupContent += '</div>';
                    layer.bindPopup(popupContent);
                }
            }
        });
        
        // Add to region layer
        geoJsonLayer.addTo(regionLayer);
        loadedLayers.regions = geoJsonLayer;
    }
    
    // Add sample provinces for demonstration
    function addSampleProvinces() {
        // This is just a fallback for demonstration purposes
        const sampleProvince = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "PROVINCE": "Metro Manila",
                        "REGION": "NCR"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[120.9, 14.4], [121.2, 14.4], [121.2, 14.8], [120.9, 14.8], [120.9, 14.4]]]
                    }
                }
            ]
        };
        
        // Style function for provinces
        function provinceStyle(feature) {
            return {
                fillColor: '#cc0000',
                weight: 2,
                opacity: 1,
                color: '#8b0000',
                dashArray: '3',
                fillOpacity: 0.3
            };
        }
        
        // Create GeoJSON layer with styling
        const geoJsonLayer = L.geoJson(sampleProvince, {
            style: provinceStyle,
            onEachFeature: function(feature, layer) {
                if (feature.properties) {
                    let popupContent = '<div class="popup-content">';
                    for (const property in feature.properties) {
                        popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                    }
                    popupContent += '</div>';
                    layer.bindPopup(popupContent);
                }
            }
        });
        
        // Add to province layer
        geoJsonLayer.addTo(provinceLayer);
        loadedLayers.provinces = geoJsonLayer;
        
        // Update status
        document.getElementById('province-status').textContent = 'Sample data';
        
        // If checkbox is checked, add to map
        if (document.getElementById('province-layer').checked) {
            map.addLayer(provinceLayer);
        }
    }
    
    // Add sample municipalities for demonstration
    function addSampleMunicipalities() {
        // This is just a fallback for demonstration purposes
        const sampleMunicipality = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "MUNICIPALITY": "Makati City",
                        "PROVINCE": "Metro Manila"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[121.0, 14.5], [121.1, 14.5], [121.1, 14.6], [121.0, 14.6], [121.0, 14.5]]]
                    }
                }
            ]
        };
        
        // Style function for municipalities
        function municipalityStyle(feature) {
            return {
                fillColor: '#ff4500',
                weight: 1,
                opacity: 0.7,
                color: '#cc0000',
                dashArray: '2',
                fillOpacity: 0.2
            };
        }
        
        // Create GeoJSON layer with styling
        const geoJsonLayer = L.geoJson(sampleMunicipality, {
            style: municipalityStyle,
            onEachFeature: function(feature, layer) {
                if (feature.properties) {
                    let popupContent = '<div class="popup-content">';
                    for (const property in feature.properties) {
                        popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                    }
                    popupContent += '</div>';
                    layer.bindPopup(popupContent);
                }
            }
        });
        
        // Add to municipality layer
        geoJsonLayer.addTo(municipalityLayer);
        loadedLayers.municipalities = geoJsonLayer;
        
        // Update status
        document.getElementById('municipality-status').textContent = 'Sample data';
        
        // If checkbox is checked, add to map
        if (document.getElementById('municipality-layer').checked) {
            map.addLayer(municipalityLayer);
        }
    }
    
    // Add sample barangays for demonstration
    function addSampleBarangays() {
        // This is just a fallback for demonstration purposes
        const sampleBarangay = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "BARANGAY": "Poblacion",
                        "MUNICIPALITY": "Makati City"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[[121.02, 14.55], [121.03, 14.55], [121.03, 14.56], [121.02, 14.56], [121.02, 14.55]]]
                    }
                }
            ]
        };
        
        // Style function for barangays
        function barangayStyle(feature) {
            return {
                fillColor: '#ff6b6b',
                weight: 0.5,
                opacity: 0.5,
                color: '#ff4500',
                fillOpacity: 0.1
            };
        }
        
        // Create GeoJSON layer with styling
        const geoJsonLayer = L.geoJson(sampleBarangay, {
            style: barangayStyle,
            onEachFeature: function(feature, layer) {
                if (feature.properties) {
                    let popupContent = '<div class="popup-content">';
                    for (const property in feature.properties) {
                        popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                    }
                    popupContent += '</div>';
                    layer.bindPopup(popupContent);
                }
            }
        });
        
        // Add to barangay layer
        geoJsonLayer.addTo(barangayLayer);
        loadedLayers.barangays = geoJsonLayer;
        
        // Update status
        document.getElementById('barangay-status').textContent = 'Sample data';
        
        // Hide warning
        document.getElementById('barangay-warning').style.display = 'none';
        
        // If checkbox is checked, add to map
        if (document.getElementById('barangay-layer').checked) {
            map.addLayer(barangayLayer);
        }
    }
    
    // Initialize the map
    function initMap() {
        // Load the regions data with heatmap visualization
        loadRegions();
        
        // Load provinces data
        loadProvinces();
        
        // Set up event listeners for layer toggles
        document.getElementById('region-layer').addEventListener('change', function() {
            if (this.checked) {
                map.addLayer(regionLayer);
            } else {
                map.removeLayer(regionLayer);
            }
        });
        
        document.getElementById('province-layer').addEventListener('change', function() {
            if (this.checked) {
                if (!loadedLayers.provinces) {
                    loadProvinces();
                } else {
                    map.addLayer(provinceLayer);
                }
            } else {
                map.removeLayer(provinceLayer);
            }
        });
        
        document.getElementById('municipality-layer').addEventListener('change', function() {
            if (this.checked) {
                if (!loadedLayers.municipalities) {
                    loadMunicipalities();
                } else {
                    map.addLayer(municipalityLayer);
                }
            } else {
                map.removeLayer(municipalityLayer);
            }
        });
        
        document.getElementById('barangay-layer').addEventListener('change', function() {
            if (this.checked) {
                if (!loadedLayers.barangays) {
                    loadBarangays();
                } else {
                    map.addLayer(barangayLayer);
                }
            } else {
                map.removeLayer(barangayLayer);
            }
        });
        
        // Set up panel toggles
        document.querySelectorAll('.panel-header').forEach(header => {
            header.addEventListener('click', function() {
                this.parentElement.classList.toggle('active');
                const icon = this.querySelector('i');
                if (icon) {
                    if (this.parentElement.classList.contains('active')) {
                        icon.className = 'fas fa-chevron-down';
                    } else {
                        icon.className = 'fas fa-chevron-right';
                    }
                }
            });
        });
        
        // Set up sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const isHidden = sidebar.style.transform === 'translateX(-350px)';
            
            if (isHidden) {
                sidebar.style.transform = 'translateX(0)';
                this.innerHTML = '<i class="fas fa-chevron-left"></i>';
            } else {
                sidebar.style.transform = 'translateX(-350px)';
                this.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
        });
        
        // Set up year slider
        const yearSlider = document.getElementById('year-slider');
        const yearValue = document.getElementById('year-value');
        yearSlider.addEventListener('input', function() {
            yearValue.textContent = this.value;
        });
        
        // Set up timeline slider
        const timelineSlider = document.getElementById('timeline-slider');
        const timelineYear = document.getElementById('timeline-year');
        timelineSlider.addEventListener('input', function() {
            timelineYear.textContent = this.value;
        });
        
        // Set up opacity slider
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityValue = document.getElementById('opacity-value');
        opacitySlider.addEventListener('input', function() {
            opacityValue.textContent = this.value;
            
            // Update layer opacity if layers are loaded
            if (loadedLayers.regions) {
                loadedLayers.regions.setStyle({
                    fillOpacity: this.value / 100
                });
            }
        });
        
        // Set up upload button
        document.getElementById('upload-btn').addEventListener('click', function() {
            const uploadPanel = document.getElementById('upload-panel');
            uploadPanel.style.display = uploadPanel.style.display === 'block' ? 'none' : 'block';
        });
        
        // Set up map click event for info panel
        map.on('click', function(e) {
            const infoPanel = document.getElementById('info-panel');
            infoPanel.innerHTML = `
                <h4>Location Information</h4>
                <p><strong>Latitude:</strong> ${e.latlng.lat.toFixed(4)}</p>
                <p><strong>Longitude:</strong> ${e.latlng.lng.toFixed(4)}</p>
                <p>Click on a region or facility for more information</p>
            `;
            infoPanel.style.display = 'block';
        });
        
        // Add a click event to close the info panel when clicking elsewhere
        map.on('popupopen', function() {
            document.getElementById('info-panel').style.display = 'none';
        });
    }
    
    // Initialize the map when the document is loaded
    document.addEventListener('DOMContentLoaded', initMap);
</script>
</body>
</html>
