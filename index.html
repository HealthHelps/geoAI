<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HealthHelp geoAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Leaflet-Geoman for drawing/uploading -->
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.css"/>
  <!-- LayerTree control (for boundary toggling) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-layers-tree/dist/Leaflet.Control.Layers.Tree.css" />
  <!-- leaflet-timeline for storyboard (optional) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-timeline/dist/leaflet-timeline.min.css"/>
  <style>
    :root {
      --primary: #b1002e;
      --accent: #e43a3a;
      --maroon: #380000;
      --glass: rgba(56,0,0,0.92);
      --glass-light: rgba(255,255,255,0.15);
      --glass-dark: rgba(56,0,0,0.85);
      --border: #e43a3a99;
      --shadow: 0 6px 32px #98000055;
      --radius: 20px;
      --header-height: 60px;
      --sidebar-width: 330px;
      --sidebar-width-collapsed: 64px;
      --transition: .33s cubic-bezier(.44,.12,.18,1.0);
      --font: 'Segoe UI', 'Arial', sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font);
      background: var(--maroon);
      color: #fff;
      overflow: hidden;
    }
    #header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--header-height);
      z-index: 30;
      background: linear-gradient(90deg, var(--primary) 65%, var(--maroon) 100%);
      box-shadow: 0 4px 20px #5008;
      display: flex;
      align-items: center;
      padding: 0 30px;
      gap: 18px;
    }
    #logo {
      height: 44px;
      border-radius: 14px;
      box-shadow: 0 0 10px #fff4;
      background: #fff;
      object-fit: contain;
    }
    #title {
      font-size: 2.1rem;
      font-weight: bold;
      letter-spacing: 2.5px;
      color: #fff;
      text-shadow: 0 2px 12px #600;
    }
    #map {
      position: absolute;
      left: 0; top: var(--header-height); right: 0; bottom: 0;
      width: 100vw;
      height: calc(100vh - var(--header-height));
      z-index: 1;
      background: #332;
      transition: background .25s;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      top: calc(var(--header-height) + 20px);
      right: 0;
      height: calc(100vh - var(--header-height) - 40px);
      width: var(--sidebar-width);
      min-width: 220px;
      max-width: 99vw;
      z-index: 20;
      background: var(--glass);
      color: #fff;
      border-radius: var(--radius) 0 0 var(--radius);
      box-shadow: var(--shadow);
      padding: 28px 26px 18px 29px;
      transition: width var(--transition), min-width var(--transition), max-width var(--transition), padding var(--transition);
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-x: hidden;
      backdrop-filter: blur(12px);
    }
    #sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
      min-width: var(--sidebar-width-collapsed);
      max-width: var(--sidebar-width-collapsed);
      padding: 18px 8px 18px 8px;
      overflow: hidden;
      align-items: center;
      justify-content: flex-start;
    }
    #sidebar .section-title {
      font-size: 1.13em;
      font-weight: bold;
      margin-bottom: 9px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      letter-spacing: 1.2px;
      color: #fff;
      transition: opacity .2s;
    }
    #sidebar.collapsed .section-title,
    #sidebar.collapsed .sidebar-content {
      opacity: 0;
      pointer-events: none;
      height: 0;
      padding: 0;
      margin: 0;
    }
    #sidebar-toggle-btn {
      position: absolute;
      left: -36px;
      top: 20px;
      width: 36px;
      height: 44px;
      background: var(--glass-dark);
      border-radius: 24px 0 0 24px;
      border: 2px solid var(--border);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4em;
      cursor: pointer;
      z-index: 60;
      box-shadow: 0 2px 8px #98000066;
      transition: left var(--transition), background var(--transition);
    }
    #sidebar.collapsed #sidebar-toggle-btn {
      left: 0;
      background: var(--glass-light);
      color: var(--accent);
    }
    /* Upload Panel - bottom middle, horizontal */
    #upload-panel {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      z-index: 25;
      background: var(--glass-light);
      padding: 12px 16px 10px 16px;
      border-radius: 20px;
      box-shadow: 0 2px 18px #98000066;
      min-width: 320px;
      max-width: 96vw;
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      gap: 20px;
      transition: right var(--transition), background .4s;
      backdrop-filter: blur(7px);
    }
    #upload-panel .upload-section {
      display: flex;
      flex-direction: column;
      gap: 7px;
      min-width: 140px;
      background: none;
    }
    #upload-panel .section-title {
      font-size: 1.08em;
      margin-bottom: 2px;
      font-weight: bold;
      border-bottom: 1px solid var(--accent);
      padding-bottom: 2px;
      color: var(--accent);
      letter-spacing: 0.8px;
      text-align: left;
    }
    .upload-group label {
      font-size: 0.95em;
      margin-bottom: 2px;
      display: block;
      color: #fff;
      letter-spacing: .6px;
    }
    .upload-group input[type="file"] {
      margin-bottom: 8px;
      width: 96%;
      background: #fff0;
      color: #fff;
      border: 1px solid #e43a3a55;
      border-radius: 7px;
      padding: 2px 0;
      font-size: 0.98em;
    }
    #save-data-btn, #clear-map-btn {
      margin-bottom: 5px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 12px;
      font-size: 0.97em;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 10px #e43a3a22;
      transition: background .17s;
      margin-right: 4px;
    }
    #save-data-btn:hover, #clear-map-btn:hover {
      background: #b1002e;
    }
    #upload-panel small {
      color: #fae;
      font-size: 0.93em;
      margin-top: 6px;
      text-align: left;
      display: block;
    }
    /* Layer controls */
    #layer-controls {
      display: flex;
      flex-direction: column;
      gap: 5px;
      margin-bottom: 12px;
    }
    .layer-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 1em;
      margin-bottom: 3px;
      background: var(--glass-light);
      padding: 3px 7px;
      border-radius: 7px;
      cursor: pointer;
      transition: background .2s;
      border: 1px solid #fff1;
    }
    .layer-toggle input[type="checkbox"] {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
    }
    /* Storyboard controls */
    #storyboard-controls {
      margin-bottom: 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: fit-content;
      min-width: 180px;
      max-width: 100%;
    }
    #storyboard-year {
      width: 100%;
    }
    #storyboard-year-value {
      font-weight: bold;
      color: var(--accent);
      margin-left: 7px;
      font-size: 1.04em;
    }
    #story-layer-select {
      min-width: 160px;
      max-width: 100%;
      font-size: 1em;
      border-radius: 8px;
      background: var(--glass-light);
      color: #fff;
      border: 1px solid var(--accent);
      padding: 5px 8px;
      font-family: inherit;
      box-shadow: 0 4px 16px #98000022;
      transition: min-width .3s, max-width .3s, background .22s;
      outline: none;
    }
    #sidebar:not(.collapsed) #story-layer-select {
      max-width: calc(var(--sidebar-width) - 60px);
      min-width: 160px;
    }
    /* Basemaps floating */
    #basemap-panel {
      position: fixed;
      left: 50%;
      top: 80px;
      transform: translateX(-50%);
      z-index: 22;
      background: var(--glass-dark);
      color: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 14px #98000066;
      padding: 7px 14px;
      min-width: 44px;
      max-width: 98vw;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      transition: max-height .3s, background .22s;
      cursor: pointer;
      user-select: none;
    }
    #basemap-panel.collapsed {
      max-height: 44px;
      overflow: hidden;
      padding: 7px 14px;
      width: 44px;
      min-width: 44px;
      border-radius: 18px;
      background: var(--accent);
      align-items: center;
      justify-content: center;
    }
    #basemap-panel .basemap-toggle-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.6em;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 0;
      margin-top: 0;
      padding: 0;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      box-shadow: 0 2px 6px #e43a3a33;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .18s;
    }
    #basemap-panel .basemap-toggle-btn:hover {
      background: var(--primary);
      color: #fff;
    }
    #basemap-panel .basemap-controls {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 7px;
      margin-top: 2px;
      margin-bottom: 2px;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    .bm-cb {
      display: flex;
      align-items: center;
      background: var(--glass-light);
      border-radius: 8px;
      padding: 4px 9px;
      color: #fff;
      font-size: 0.97em;
      cursor: pointer;
      border: 1px solid #e43a3a44;
      min-width: 70px;
      font-family: inherit;
      transition: background .13s;
    }
    .bm-cb input[type="checkbox"] {
      accent-color: var(--accent);
      margin-right: 5px;
    }
    .bm-cb.selected {
      background: var(--accent);
      color: #fff;
    }
    /* Attribute popup */
    .attribute-popup {
      min-width: 220px;
      font-size: 1.03em;
      color: #222;
      background: #fff;
      border-radius: 10px;
      padding: 12px 11px;
      box-shadow: 0 2px 14px #e43a3a33;
      border: 1px solid var(--accent);
      font-family: inherit;
    }
    ::selection {
      background: #C81E1E;
      color: #fff;
    }
    @media (max-width: 900px) {
      #sidebar {
        max-width: 98vw;
        min-width: 40vw;
      }
      #upload-panel {
        left: 50vw;
        max-width: 97vw;
      }
      #basemap-panel {
        left: 50vw;
        max-width: 97vw;
      }
    }
    @media (max-width: 650px) {
      #sidebar {
        padding: 9px 4px 9px 7px;
        font-size: 0.93em;
      }
      #upload-panel {
        padding: 8px 8px 8px 8px;
        font-size: .93em;
        gap:10px;
      }
      #header {
        padding: 0 7px;
      }
      #logo { height: 28px;}
      #title { font-size: 1.17rem;}
      #basemap-panel .bm-cb { min-width: 54px; font-size:.93em;}
    }
    /* Animations */
    .fade-in {
      animation: fadein .7s ease;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(15px);}
      to { opacity: 1; transform: translateY(0);}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="header">
    <img id="logo" src="HealthHelpLogo.png" alt="HealthHelp Logo">
    <div id="title">HealthHelp geoAI</div>
  </div>

  <!-- Main Map -->
  <div id="map"></div>

  <!-- Sidebar -->
  <div id="sidebar" class="">
    <div id="sidebar-toggle-btn" title="Collapse/Expand">&#9776;</div>
    <div class="sidebar-content">
      <div class="section-title">Layer Controls</div>
      <div id="layer-controls"></div>
      <div class="section-title">Thematic Storyboard</div>
      <div id="storyboard-controls">
        <label for="storyboard-year">Year:</label>
        <input type="range" id="storyboard-year" min="2010" max="2025" value="2025" step="1" />
        <span id="storyboard-year-value">2025</span>
        <select id="story-layer-select">
          <option value="maternal">Maternal/Newborn/Child Death Rate</option>
          <option value="hiv">HIV/AIDS-related Death Rate</option>
          <option value="facilities">Health Facilities Count</option>
          <option value="poverty-maternal">High Poverty+Population+Maternal/Newborn/Child Death Rate</option>
          <option value="poverty-hiv">High Poverty+Population+HIV/AIDS-related Death Rate</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Upload/Analyze Panel (floating, always over map, bottom-middle, horizontal) -->
  <div id="upload-panel" class="fade-in">
    <div class="upload-section">
      <div class="section-title">Upload Shapefile (.zip)</div>
      <div class="upload-group">
        <input type="file" id="upload-shapefile" accept=".zip">
      </div>
    </div>
    <div class="upload-section">
      <div class="section-title">Upload GeoJSON</div>
      <div class="upload-group">
        <input type="file" id="upload-geojson" accept=".geojson,application/json">
      </div>
    </div>
    <div class="upload-section">
      <div class="section-title">Upload Other Geospatial Files</div>
      <div class="upload-group">
        <input type="file" id="upload-other" accept=".kml,.gpx,.csv">
      </div>
    </div>
    <div class="upload-section">
      <div style="display:flex;gap:5px;">
        <button type="button" id="save-data-btn">Save Locally</button>
        <button type="button" id="clear-map-btn">Clear Map</button>
      </div>
      <small>Uploaded data stays until you clear the map.<br>Click anywhere on the map to show attributes.</small>
    </div>
  </div>

  <!-- Basemap Panel (floating, collapsed by default, top-middle)-->
  <div id="basemap-panel" class="collapsed">
    <button id="basemap-toggle-btn" class="basemap-toggle-btn" title="Show/Hide Basemaps">&#127760;</button>
    <div class="basemap-controls" style="display:none;"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet-Geoman for draw/upload -->
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.min.js"></script>
  <!-- LayerTree control (for boundary toggling) -->
  <script src="https://unpkg.com/leaflet-control-layers-tree/dist/Leaflet.Control.Layers.Tree.js"></script>
  <!-- leaflet-timeline -->
  <script src="https://unpkg.com/leaflet-timeline/dist/leaflet-timeline.min.js"></script>
  <!-- shp.js for reading zipped shapefiles -->
  <script src="https://unpkg.com/shpjs/dist/shp.min.js"></script>
  <!-- toGeoJSON for KML/GPX -->
  <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.min.js"></script>
  <!-- JSZip for zip file handling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // Map Initialization
    const map = L.map('map', {
      center: [12.8797, 121.7740],
      zoom: 6,
      minZoom: 5,
      maxZoom: 16,
      attributionControl: false,
      zoomControl: true,
      preferCanvas: true
    });

    // Basemap Layers (multi-select)
    const basemaps = {
      "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {id:'osm', attribution:'&copy; OpenStreetMap contributors'}),
      "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {id:'satellite', attribution:'&copy; ESRI, Maxar'}),
      "Satellite+Labels": L.layerGroup([
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {id:'satellite', attribution:''}),
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {id:'labels', opacity: 0.5, attribution:''})
      ]),
      "Dark": L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_dark/{z}/{x}/{y}{r}.png', {id:'dark', attribution:'&copy; Stadia Maps'}),
      "Terrain": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {id:'terrain', attribution:'&copy; OpenTopoMap'}),
      "CartoDB Positron": L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {id:'carto', attribution:'&copy; CartoDB'})
    };
    basemaps["OpenStreetMap"].addTo(map);

    // Basemap Controls Panel (floating)
    const basemapPanel = document.getElementById("basemap-panel");
    const basemapControlsDiv = basemapPanel.querySelector(".basemap-controls");
    document.getElementById("basemap-toggle-btn").onclick = function() {
      basemapPanel.classList.toggle("collapsed");
      if (basemapPanel.classList.contains("collapsed")) {
        basemapControlsDiv.style.display = "none";
      } else {
        basemapControlsDiv.style.display = "flex";
      }
    };
    // Multi-select checkboxes for basemaps
    Object.keys(basemaps).forEach((bm, i) => {
      const wrap = document.createElement("div");
      wrap.className = "bm-cb";
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = `bm-${bm.replace(/\s/g,'')}`;
      cb.checked = (bm === "OpenStreetMap");
      wrap.classList.toggle("selected", cb.checked);
      cb.onchange = () => {
        if (cb.checked) {
          basemaps[bm].addTo(map);
        } else {
          map.removeLayer(basemaps[bm]);
        }
        wrap.classList.toggle("selected", cb.checked);
      };
      wrap.appendChild(cb);
      wrap.appendChild(document.createTextNode(bm));
      basemapControlsDiv.appendChild(wrap);
    });

    // Responsive sidebar width for storyboard dropdown
    function adjustSidebarWidth() {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar.classList.contains('collapsed')) {
        let select = document.getElementById('story-layer-select');
        let longest = Array.from(select.options).reduce((a, o) => o.text.length > a ? o.text.length : a, 0);
        let width = Math.max(330, longest * 10 + 120);
        sidebar.style.width = width + "px";
      } else {
        sidebar.style.width = "64px";
      }
    }
    document.getElementById('story-layer-select').onchange = adjustSidebarWidth;
    window.addEventListener('resize', adjustSidebarWidth);
    setTimeout(adjustSidebarWidth, 1000);

    // Sidebar expand/collapse
    const sidebar = document.getElementById('sidebar');
    document.getElementById('sidebar-toggle-btn').onclick = function () {
      sidebar.classList.toggle('collapsed');
      adjustSidebarWidth();
      setTimeout(() => adjustSidebarWidth(), 350);
    };

    // Layer Controls
    const boundarySources = [
      {
        name: "Philippines (Region)",
        url: "https://github.com/HealthHelps/geoAI/raw/main/Philippines.zip",
        color: "#b1002e"
      },
      {
        name: "Provinces",
        url: "https://github.com/HealthHelps/geoAI/raw/main/Provinces.zip",
        color: "#e43a3a"
      },
      {
        name: "Towns",
        url: "https://github.com/HealthHelps/geoAI/raw/main/Towns.zip",
        color: "#ffb0b0"
      },
      {
        name: "Barangays",
        url: "https://github.com/HealthHelps/geoAI/raw/main/Barangay.zip",
        color: "#fbdcdc"
      }
    ];
    const boundaryLayers = {};
    function styleBoundary(color) {
      return {
        color: color,
        fill: false,
        weight: 2,
        opacity: 0.8
      };
    }
    function addBoundaryLayer(name, url, color) {
      fetch(url)
        .then(res => res.blob())
        .then(blob => {
          shp(blob).then(geojson => {
            boundaryLayers[name] = L.geoJson(geojson, {
              style: styleBoundary(color),
              onEachFeature: onEachFeature,
              pmIgnore: false
            });
            boundaryLayers[name].addTo(map); // Show by default
            updateLayerControls();
          });
        });
    }
    boundarySources.forEach(b => addBoundaryLayer(b.name, b.url, b.color));
    function updateLayerControls() {
      const layerDiv = document.getElementById("layer-controls");
      layerDiv.innerHTML = '';
      Object.keys(boundaryLayers).forEach(level => {
        const wrap = document.createElement("div");
        wrap.className = "layer-toggle";
        const check = document.createElement("input");
        check.type = "checkbox";
        check.id = `layer-${level.replace(/\s/g,'')}`;
        check.checked = map.hasLayer(boundaryLayers[level]);
        check.onchange = (e) => {
          if (e.target.checked) map.addLayer(boundaryLayers[level]);
          else map.removeLayer(boundaryLayers[level]);
        };
        const lbl = document.createElement("label");
        lbl.htmlFor = check.id;
        lbl.innerText = level;
        wrap.appendChild(check);
        wrap.appendChild(lbl);
        layerDiv.appendChild(wrap);

        // Enable hover highlight
        wrap.onmouseenter = () => {
          boundaryLayers[level].setStyle({color:'#e43a3a', weight:4});
        };
        wrap.onmouseleave = () => {
          boundaryLayers[level].setStyle(styleBoundary(boundarySources.find(b=>b.name==level).color));
        };
      });
    }

    // Thematic Layer Data (demo only; replace with real)
    let thematicData = {
      maternal: {}, hiv: {}, facilities: {}, "poverty-maternal": {}, "poverty-hiv": {}
    };
    function loadThematicData() {
      // Demo: region-level polygons and random values for each year
      fetch(boundarySources[0].url)
        .then(res => res.blob())
        .then(blob => shp(blob))
        .then(geojson => {
          for (let type of Object.keys(thematicData)) {
            thematicData[type] = {};
            for (let year=2010; year<=2025; year++) {
              thematicData[type][year] = L.geoJson(geojson, {
                style: feature => {
                  const val = Math.random();
                  let fill;
                  if (type==='maternal') fill = `rgba(200,30,30,${0.4+val*0.5})`;
                  else if (type==='hiv') fill = `rgba(221,0,97,${0.4+val*0.5})`;
                  else if (type==='facilities') fill = `rgba(92,0,32,${0.4+val*0.5})`;
                  else fill = `rgba(130,0,0,${0.4+val*0.5})`;
                  return {fillColor: fill, color: "#980000", weight: 1, fillOpacity: 0.45+val*0.35};
                },
                onEachFeature: onEachFeature,
                pmIgnore: false
              });
            }
          }
        });
    }
    loadThematicData();

    // Health Facilities Points (demo)
    let healthFacilities = L.layerGroup();
    function loadDemoFacilities() {
      let demoData = [
        {name:"RHUs Manila", type:"RHU", lat:14.6, lng:120.98, services:["MNCH","FP","HIV/AIDS"], ownership:"public"},
        {name:"PHU Pampanga", type:"PHU", lat:15.05, lng:120.69, services:["MNCH"], ownership:"public"},
        {name:"BHC Cebu", type:"BHC", lat:10.31, lng:123.89, services:["MNCH","FP"], ownership:"public"},
        {name:"Lying-In Clinic Makati", type:"Clinic", lat:14.55, lng:121.02, services:["MNCH","FP"], ownership:"private"}
      ];
      demoData.forEach(f => {
        let marker = L.circleMarker([f.lat, f.lng], {
          color: f.ownership==='public'? "#e13c3c":"#980000",
          radius: 9,
          fillOpacity: 0.85
        }).bindPopup(`
          <div class="attribute-popup">
            <b>${f.name}</b><br>
            Type: ${f.type}<br>
            Services: ${f.services.join(", ")}<br>
            Ownership: ${f.ownership}
          </div>
        `);
        healthFacilities.addLayer(marker);
      });
    }
    loadDemoFacilities();
    healthFacilities.addTo(map);

    // Storyboard Controls
    let activeStoryLayer = "maternal";
    let activeYear = 2025;
    let thematicLayer = null;
    function updateStoryboard() {
      if (thematicLayer) map.removeLayer(thematicLayer);
      thematicLayer = thematicData[activeStoryLayer] && thematicData[activeStoryLayer][activeYear];
      if (thematicLayer) thematicLayer.addTo(map);
    }
    document.getElementById("storyboard-year").oninput = function(e){
      activeYear = parseInt(e.target.value);
      document.getElementById("storyboard-year-value").innerText = activeYear;
      updateStoryboard();
    };
    document.getElementById("story-layer-select").onchange = function(e){
      activeStoryLayer = e.target.value;
      updateStoryboard();
      adjustSidebarWidth();
    };
    setTimeout(updateStoryboard, 2500);

    // Upload/Save/Clear Functions
    let uploadedLayers = [];
    function handleFileUpload(file, type) {
      if (type === "shapefile") {
        shp(file).then(function(geojson){
          const lyr = L.geoJson(geojson, {
            style: {color: "#ad1d1d", fillColor: "#d45e5e", fillOpacity: 0.45},
            onEachFeature: onEachFeature,
            pmIgnore: false
          });
          lyr.addTo(map);
          uploadedLayers.push(lyr);
          geoAI.analyze(geojson);
        });
      } else if (type === "geojson") {
        const reader = new FileReader();
        reader.onload = function(e){
          const geojson = JSON.parse(e.target.result);
          const lyr = L.geoJson(geojson, {
            style: {color: "#ad1d1d", fillColor: "#d45e5e", fillOpacity: 0.45},
            onEachFeature: onEachFeature,
            pmIgnore: false
          });
          lyr.addTo(map);
          uploadedLayers.push(lyr);
          geoAI.analyze(geojson);
        };
        reader.readAsText(file);
      } else {
        const reader = new FileReader();
        reader.onload = function(e){
          let geojson;
          if (file.name.endsWith('.kml')) {
            const parser = new DOMParser();
            const kml = parser.parseFromString(e.target.result, 'text/xml');
            geojson = toGeoJSON.kml(kml);
          } else if (file.name.endsWith('.gpx')) {
            const parser = new DOMParser();
            const gpx = parser.parseFromString(e.target.result, 'text/xml');
            geojson = toGeoJSON.gpx(gpx);
          } else if (file.name.endsWith('.csv')) {
            geojson = {type:"FeatureCollection",features:[]};
            const lines = e.target.result.split('\n');
            for (let line of lines.slice(1)) {
              const vals = line.split(',');
              if (vals.length<2) continue;
              geojson.features.push({
                type:"Feature",
                geometry:{type:"Point",coordinates:[parseFloat(vals[1]),parseFloat(vals[0])]},
                properties:{}
              });
            }
          }
          if (geojson) {
            const lyr = L.geoJson(geojson, {
              style: {color: "#ad1d1d", fillColor: "#d45e5e", fillOpacity: 0.45},
              onEachFeature: onEachFeature,
              pmIgnore: false
            });
            lyr.addTo(map);
            uploadedLayers.push(lyr);
            geoAI.analyze(geojson);
          }
        };
        reader.readAsText(file);
      }
    }
    document.getElementById("upload-shapefile").onchange = function(e){
      if (e.target.files.length) handleFileUpload(e.target.files[0], "shapefile");
      e.target.value = '';
    };
    document.getElementById("upload-geojson").onchange = function(e){
      if (e.target.files.length) handleFileUpload(e.target.files[0], "geojson");
      e.target.value = '';
    };
    document.getElementById("upload-other").onchange = function(e){
      if (e.target.files.length) handleFileUpload(e.target.files[0], "other");
      e.target.value = '';
    };
    document.getElementById("save-data-btn").onclick = function(){
      alert("Local data saving is only available in modern browsers. Data will be downloaded as GeoJSON.");
      let allFeatures = [];
      uploadedLayers.forEach(layer => {
        if (layer.toGeoJSON) {
          try {
            const geojson = layer.toGeoJSON();
            if (geojson.features) allFeatures = allFeatures.concat(geojson.features);
          } catch(e){}
        }
      });
      if (allFeatures.length === 0) {
        alert("No uploaded data to save.");
        return;
      }
      const blob = new Blob([JSON.stringify({type:'FeatureCollection',features:allFeatures})], {type: "application/json"});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "healthhelp_uploaded_data.geojson";
      a.click();
    };
    document.getElementById("clear-map-btn").onclick = function(){
      uploadedLayers.forEach(lyr => map.removeLayer(lyr));
      uploadedLayers = [];
    };

    // geoAI Functions
    const geoAI = {
      analyze: (data) => {
        // Placeholder for advanced geoAI analysis
        // You can replace/extend with real analytics
        console.log("geoAI: Analyzing data...", data);
      },
      visualize: (data) => {
        // Placeholder for advanced geoAI visualization
        console.log("geoAI: Visualizing data...", data);
      }
    };

    // Attribute popup on click
    function onEachFeature(feature, layer) {
      layer.on('click', function (e) {
        let props = feature.properties || {};
        let html = '<div class="attribute-popup"><b>Attributes:</b><br>';
        for (let k in props) {
          html += `<span style="color:#980000;font-weight:bold;">${k}</span>: ${props[k]}<br>`;
        }
        html += '</div>';
        layer.bindPopup(html).openPopup();
      });
      // Enable editing by clicking the edit button in pm toolbar
      layer.on('pm:edit', function(e) {
        geoAI.visualize(layer.toGeoJSON());
      });
    }
    map.on('click', function(e){
      if (sidebar.classList.contains('collapsed')) return;
      L.popup()
        .setLatLng(e.latlng)
        .setContent(`<div class="attribute-popup"><b>Coordinates:</b><br>Lat: ${e.latlng.lat.toFixed(6)}<br>Lng: ${e.latlng.lng.toFixed(6)}</div>`)
        .openOn(map);
    });

    // Leaflet-Geoman Controls (draw/upload)
    map.pm.addControls({
      position: 'topleft',
      drawMarker: true,
      drawPolygon: true,
      drawPolyline: true,
      drawCircle: true,
      drawRectangle: true,
      drawCircleMarker: true,
      editMode: true,
      dragMode: true,
      cutPolygon: true,
      removalMode: true,
      rotateMode: false
    });
    map.on('pm:create', e => {
      geoAI.visualize(e.layer.toGeoJSON());
      e.layer.bindPopup('<b>Custom Geometry</b>').openPopup();
      uploadedLayers.push(e.layer);
    });

    // Add scale
    L.control.scale({position:'bottomleft'}).addTo(map);

    // Add attribution
    L.control.attribution({position:'bottomright'}).addAttribution('HealthHelp geoAI &copy; 2025 | <a href="https://github.com/HealthHelps/geoAI" style="color:#e8a;">Source</a>');

    // Responsive map height
    function resizeMap() {
      document.getElementById("map").style.height = (window.innerHeight - document.getElementById("header").offsetHeight) + "px";
    }
    window.onresize = resizeMap;
    resizeMap();
  </script>
</body>
</html>
