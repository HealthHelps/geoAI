<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthHelp GeoAI - Philippines Health Mapping</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            overflow: hidden;
            color: #333;
        }
        
        #header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background-color: #8b0000; /* Dark red */
            color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        #logo {
            height: 50px;
            margin-right: 15px;
        }
        
        #title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        #main-container {
            position: absolute;
            top: 70px;
            left: 0;
            width: 100%;
            height: calc(100% - 70px);
            display: flex;
        }
        
        #sidebar {
            width: 350px;
            height: 100%;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 15px;
            z-index: 900;
            transition: transform 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        
        #map-container {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .panel {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            overflow: hidden;
        }
        
        .panel-header {
            background-color: #a52a2a; /* Maroon */
            color: white;
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-content {
            padding: 15px;
            display: none;
        }
        
        .panel.active .panel-content {
            display: block;
        }
        
        .layer-control {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .layer-control input {
            margin-right: 10px;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #8b0000;
        }
        
        .slider {
            width: 100%;
        }
        
        .button {
            background-color: #8b0000;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            text-align: left;
        }
        
        .button:hover {
            background-color: #a52a2a;
        }
        
        .button i {
            margin-right: 8px;
        }
        
        .toggle-sidebar {
            position: absolute;
            top: 80px;
            left: 350px;
            z-index: 950;
            background: #8b0000;
            color: white;
            border: none;
            width: 20px;
            height: 40px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 800;
            max-width: 200px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #999;
        }
        
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 800;
            max-width: 300px;
            display: none;
        }
        
        .health-facility-marker {
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .year-slider-container {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%); 
            z-index: 800;
            width: 60%;
            min-width: 300px;
        }
        
        .basemap-selector {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 800;
        }
        
        .upload-panel {
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 150px;
            right: 20px;
            z-index: 800;
            width: 250px;
            display: none;
        }
        
        .loading-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(139, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #8b0000;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .layer-status {
            font-size: 0.8rem;
            color: #666;
            margin-left: 10px;
        }
        
        .error-message {
            color: #d9534f;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .warning-message {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .progress-bar {
            height: 5px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #8b0000;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="header">
        <img src="https://raw.githubusercontent.com/HealthHelps/geoAI/main/HealthHelpLogo.png" alt="HealthHelp Logo" id="logo">
        <h1 id="title">HealthHelp GeoAI</h1>
    </div>
    
<div id="main-container">
    <div id="sidebar">
        <!-- NEW BASEMAP PANEL -->
        <div class="panel active">
            <div class="panel-header">
                <span>Basemap</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <select id="basemap-select" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="osm">OpenStreetMap</option>
                    <option value="satellite" selected>Satellite</option>
                    <option value="terrain">Terrain</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>

        <!-- BOUNDARY LAYERS PANEL -->
        <div class="panel active">
            <div class="panel-header">
                <span>Boundary Layers</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <div class="layer-control">
                    <input type="checkbox" id="region-layer" checked>
                    <label for="region-layer">Regions</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="province-layer" checked>
                    <label for="province-layer">Provinces</label>
                    <span id="province-status" class="layer-status">Loading...</span>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="municipality-layer">
                    <label for="municipality-layer">Municipalities</label>
                    <span id="municipality-status" class="layer-status">Click to load</span>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="barangay-layer">
                    <label for="barangay-layer">Barangays</label>
                    <span id="barangay-status" class="layer-status">Click to load</span>
                </div>
                <div class="warning-message" id="barangay-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> Barangays data is large and may take time to load.
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="barangay-progress"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HEALTH FACILITIES PANEL -->
        <div class="panel">
            <div class="panel-header">
                <span>Health Facilities</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <div class="layer-control">
                    <input type="checkbox" id="rhu-layer">
                    <label for="rhu-layer">Regional Health Units (RHUs)</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="phu-layer">
                    <label for="phu-layer">Provincial Health Units (PHUs)</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="ruralhu-layer">
                    <label for="ruralhu-layer">Rural Health Units</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="bhc-layer">
                    <label for="bhc-layer">Barangay Health Centers (BHCs)</label>
                </div>
                <div class="layer-control">
                    <input type="checkbox" id="lyingin-layer">
                    <label for="lyingin-layer">Lying-In Clinics</label>
                </div>
                
                <div class="slider-container">
                    <label>Services Filter:</label>
                    <select id="services-filter" class="slider">
                        <option value="all">All Services</option>
                        <option value="mnch">Maternal, Newborn, and Child Health (MNCH)</option>
                        <option value="fp">Family Planning (FP)</option>
                        <option value="hiv">HIV/AIDS Health Services</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- THEMATIC MAPS PANEL -->
        <div class="panel">
            <div class="panel-header">
                <span>Thematic Maps</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <button class="button" id="maternal-heatmap-btn">
                    <i class="fas fa-baby"></i> Maternal & Child Death Rate
                </button>
                <button class="button" id="hiv-heatmap-btn">
                    <i class="fas fa-virus"></i> HIV/AIDS Death Rate
                </button>
                <button class="button" id="facility-heatmap-btn">
                    <i class="fas fa-hospital"></i> Health Facility Coverage
                </button>
                <button class="button" id="poverty-mnch-btn">
                    <i class="fas fa-exclamation-triangle"></i> Poverty & MNCH Intersection
                </button>
                <button class="button" id="poverty-hiv-btn">
                    <i class="fas fa-exclamation-triangle"></i> Poverty & HIV Intersection
                </button>
                
                <div class="slider-container">
                    <label for="year-slider">Year: <span id="year-value">2023</span></label>
                    <input type="range" id="year-slider" class="slider" min="2010" max="2025" value="2023" step="1">
                </div>
                
                <div class="slider-container">
                    <label for="opacity-slider">Opacity: <span id="opacity-value">70</span>%</label>
                    <input type="range" id="opacity-slider" class="slider" min="0" max="100" value="70" step="1">
                </div>
            </div>
        </div>

        <!-- GEOAI TOOLS PANEL -->
        <div class="panel">
            <div class="panel-header">
                <span>GeoAI Tools</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="panel-content">
                <button class="button" id="upload-btn">
                    <i class="fas fa-upload"></i> Upload Data
                </button>
                <button class="button" id="analyze-btn">
                    <i class="fas fa-chart-line"></i> Analyze Data
                </button>
                <button class="button" id="predict-btn">
                    <i class="fas fa-robot"></i> Predict Trends
                </button>
                <button class="button" id="export-btn">
                    <i class="fas fa-download"></i> Export Map
                </button>
            </div>
        </div>
    </div>
    
    <!-- MAP CONTAINER (unchanged) -->
    <div id="map-container">
        <div id="map"></div>
        
        <button class="toggle-sidebar" id="sidebar-toggle">
            <i class="fas fa-chevron-left"></i>
        </button>
        
        <div class="legend" id="legend">
            <h4>Boundary Layers</h4>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #8b0000;"></div>
                <span>Regions</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #cc0000;"></div>
                <span>Provinces</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff4500;"></div>
                <span>Municipalities</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff6b6b;"></div>
                <span>Barangays</span>
            </div>
        </div>
        
        <div class="info-panel" id="info-panel">
            <h4>Location Information</h4>
            <p>Click on the map to get information</p>
        </div>
        
        <div class="year-slider-container" id="year-slider-container">
            <label for="timeline-slider">Timeline: <span id="timeline-year">2023</span></label>
            <input type="range" id="timeline-slider" class="slider" min="2010" max="2025" value="2023" step="1">
        </div>
        
        <!-- REMOVE the standalone basemap-selector from here -->
        
        <div class="upload-panel" id="upload-panel">
            <h4>Upload Geospatial Data</h4>
            <input type="file" id="file-upload" accept=".shp,.geojson,.kml,.gpkg" multiple>
            <p>Supported formats: Shapefile, GeoJSON, KML</p>
            <button class="button" id="process-upload">
                <i class="fas fa-cog"></i> Process Data
            </button>
        </div>
    </div>
</div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>Health Facilities</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <div class="layer-control">
                        <input type="checkbox" id="rhu-layer">
                        <label for="rhu-layer">Regional Health Units (RHUs)</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="phu-layer">
                        <label for="phu-layer">Provincial Health Units (PHUs)</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="ruralhu-layer">
                        <label for="ruralhu-layer">Rural Health Units</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="bhc-layer">
                        <label for="bhc-layer">Barangay Health Centers (BHCs)</label>
                    </div>
                    <div class="layer-control">
                        <input type="checkbox" id="lyingin-layer">
                        <label for="lyingin-layer">Lying-In Clinics</label>
                    </div>
                    
                    <div class="slider-container">
                        <label>Services Filter:</label>
                        <select id="services-filter" class="slider">
                            <option value="all">All Services</option>
                            <option value="mnch">Maternal, Newborn, and Child Health (MNCH)</option>
                            <option value="fp">Family Planning (FP)</option>
                            <option value="hiv">HIV/AIDS Health Services</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>Thematic Maps</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <button class="button" id="maternal-heatmap-btn">
                        <i class="fas fa-baby"></i> Maternal & Child Death Rate
                    </button>
                    <button class="button" id="hiv-heatmap-btn">
                        <i class="fas fa-virus"></i> HIV/AIDS Death Rate
                    </button>
                    <button class="button" id="facility-heatmap-btn">
                        <i class="fas fa-hospital"></i> Health Facility Coverage
                    </button>
                    <button class="button" id="poverty-mnch-btn">
                        <i class="fas fa-exclamation-triangle"></i> Poverty & MNCH Intersection
                    </button>
                    <button class="button" id="poverty-hiv-btn">
                        <i class="fas fa-exclamation-triangle"></i> Poverty & HIV Intersection
                    </button>
                    
                    <div class="slider-container">
                        <label for="year-slider">Year: <span id="year-value">2023</span></label>
                        <input type="range" id="year-slider" class="slider" min="2010" max="2025" value="2023" step="1">
                    </div>
                    
                    <div class="slider-container">
                        <label for="opacity-slider">Opacity: <span id="opacity-value">70</span>%</label>
                        <input type="range" id="opacity-slider" class="slider" min="0" max="100" value="70" step="1">
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">
                    <span>GeoAI Tools</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="panel-content">
                    <button class="button" id="upload-btn">
                        <i class="fas fa-upload"></i> Upload Data
                    </button>
                    <button class="button" id="analyze-btn">
                        <i class="fas fa-chart-line"></i> Analyze Data
                    </button>
                    <button class="button" id="predict-btn">
                        <i class="fas fa-robot"></i> Predict Trends
                    </button>
                    <button class="button" id="export-btn">
                        <i class="fas fa-download"></i> Export Map
                    </button>
                </div>
            </div>
        </div>
        
        <div id="map-container">
            <div id="map"></div>
            
            <button class="toggle-sidebar" id="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div class="legend" id="legend">
                <h4>Boundary Layers</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #8b0000;"></div>
                    <span>Regions</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #cc0000;"></div>
                    <span>Provinces</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff4500;"></div>
                    <span>Municipalities</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff6b6b;"></div>
                    <span>Barangays</span>
                </div>
            </div>
            
            <div class="info-panel" id="info-panel">
                <h4>Location Information</h4>
                <p>Click on the map to get information</p>
            </div>
            
            <div class="year-slider-container" id="year-slider-container">
                <label for="timeline-slider">Timeline: <span id="timeline-year">2023</span></label>
                <input type="range" id="timeline-slider" class="slider" min="2010" max="2025" value="2023" step="1">
            </div>
                      
            <div class="upload-panel" id="upload-panel">
                <h4>Upload Geospatial Data</h4>
                <input type="file" id="file-upload" accept=".shp,.geojson,.kml,.gpkg" multiple>
                <p>Supported formats: Shapefile, GeoJSON, KML</p>
                <button class="button" id="process-upload">
                    <i class="fas fa-cog"></i> Process Data
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<script>
    // Initialize the map
    const map = L.map('map', {
        center: [12.8797, 121.7740], // Philippines coordinates
        zoom: 6,
        minZoom: 5,
        maxZoom: 18,
        zoomControl: false
    });
    
    // Add zoom control to top-right
    L.control.zoom({
        position: 'topright'
    }).addTo(map);
    
    // Define basemaps
    const basemaps = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        }),
        terrain: L.tileLayer('https://{s}.tile.openttopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://openttopomap.org">OpenTopoMap</a>'
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        })
    };
    
    // Add default basemap (Satellite instead of OSM)
    basemaps.satellite.addTo(map);
        
        // Add layer groups for boundaries
        const regionLayer = L.layerGroup().addTo(map);
        const provinceLayer = L.layerGroup();
        const municipalityLayer = L.layerGroup();
        const barangayLayer = L.layerGroup();
        
        // Store loaded layers for toggle functionality
        const loadedLayers = {
            provinces: null,
            municipalities: null,
            barangays: null
        };
        
        // Function to handle GeoJSON loading errors
        function handleGeoJSONError(error, layerType) {
            console.error(`Error loading ${layerType}:`, error);
            const statusElement = document.getElementById(`${layerType}-status`);
            statusElement.textContent = 'Error loading';
            
            // Add error message with retry button
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `Failed to load ${layerType}. 
                <a href="#" onclick="load${layerType.charAt(0).toUpperCase() + layerType.slice(1)}(); return false;">
                    Retry
                </a>`;
            
            statusElement.parentNode.appendChild(errorDiv);
            
            // Add sample data for demonstration
            if (layerType === 'province') {
                addSampleProvinces();
            } else if (layerType === 'municipality') {
                addSampleMunicipalities();
            } else if (layerType === 'barangay') {
                addSampleBarangays();
            }
        }
        
        // Load province boundaries from GitHub
        function loadProvinces() {
            const statusElement = document.getElementById('province-status');
            // Clear any previous error messages
            const errorMessages = statusElement.parentNode.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
            
            statusElement.innerHTML = '<div class="loading-indicator"></div>';
            
            // Load the GeoJSON file from GitHub
            fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Provinces.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if data was loaded correctly
                    if (!data || !data.features || data.features.length === 0) {
                        throw new Error('No features found in the GeoJSON');
                    }
                    
                    // Style function for provinces
                    function provinceStyle(feature) {
                        return {
                            fillColor: '#cc0000',
                            weight: 2,
                            opacity: 1,
                            color: '#8b0000',
                            dashArray: '3',
                            fillOpacity: 0.3
                        };
                    }
                    
                    // Create GeoJSON layer with styling
                    const geoJsonLayer = L.geoJson(data, {
                        style: provinceStyle,
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                let popupContent = '<div class="popup-content">';
                                for (const property in feature.properties) {
                                    popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                                }
                                popupContent += '</div>';
                                layer.bindPopup(popupContent);
                            }
                        }
                    });
                    
                    // Clear any existing layers
                    provinceLayer.clearLayers();
                    
                    // Add to province layer
                    geoJsonLayer.addTo(provinceLayer);
                    loadedLayers.provinces = geoJsonLayer;
                    
                    // Update status
                    statusElement.textContent = 'Loaded';
                    
                    // If checkbox is checked, add to map
                    if (document.getElementById('province-layer').checked) {
                        map.addLayer(provinceLayer);
                    }
                })
                .catch(function(error) {
                    handleGeoJSONError(error, 'province');
                });
        }
        
        // Load municipality boundaries from GitHub
        function loadMunicipalities() {
            const statusElement = document.getElementById('municipality-status');
            // Clear any previous error messages
            const errorMessages = statusElement.parentNode.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
            
            statusElement.innerHTML = '<div class="loading-indicator"></div>';
            
            // Load the GeoJSON file from GitHub
            fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Towns.geojson')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if data was loaded correctly
                    if (!data || !data.features || data.features.length === 0) {
                        throw new Error('No features found in the GeoJSON');
                    }
                    
                    // Style function for municipalities
                    function municipalityStyle(feature) {
                        return {
                            fillColor: '#ff4500',
                            weight: 1,
                            opacity: 0.7,
                            color: '#cc0000',
                            dashArray: '2',
                            fillOpacity: 0.2
                        };
                    }
                    
                    // Create GeoJSON layer with styling
                    const geoJsonLayer = L.geoJson(data, {
                        style: municipalityStyle,
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                let popupContent = '<div class="popup-content">';
                                for (const property in feature.properties) {
                                    popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                                }
                                popupContent += '</div>';
                                layer.bindPopup(popupContent);
                            }
                        }
                    });
                    
                    // Clear any existing layers
                    municipalityLayer.clearLayers();
                    
                    // Add to municipality layer
                    geoJsonLayer.addTo(municipalityLayer);
                    loadedLayers.municipalities = geoJsonLayer;
                    
                    // Update status
                    statusElement.textContent = 'Loaded';
                    
                    // If checkbox is checked, add to map
                    if (document.getElementById('municipality-layer').checked) {
                        map.addLayer(municipalityLayer);
                    }
                })
                .catch(function(error) {
                    handleGeoJSONError(error, 'municipality');
                });
        }
        
        // Load barangay boundaries from GitHub with better error handling
        function loadBarangays() {
            const statusElement = document.getElementById('barangay-status');
            const warningElement = document.getElementById('barangay-warning');
            const progressElement = document.getElementById('barangay-progress');
            
            // Clear any previous error messages
            const errorMessages = statusElement.parentNode.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
            
            statusElement.innerHTML = '<div class="loading-indicator"></div>';
            warningElement.style.display = 'block';
            progressElement.style.width = '10%';
            
            // Load the GeoJSON file from GitHub
            fetch('https://raw.githubusercontent.com/HealthHelps/geoAI/main/Barangays.geojson')
                .then(response => {
                    progressElement.style.width = '30%';
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    progressElement.style.width = '60%';
                    // Check if data was loaded correctly
                    if (!data || !data.features || data.features.length === 0) {
                        throw new Error('No features found in the GeoJSON');
                    }
                    
                    // Style function for barangays
                    function barangayStyle(feature) {
                        return {
                            fillColor: '#ff6b6b',
                            weight: 0.5,
                            opacity: 0.5,
                            color: '#ff4500',
                            dashArray: '1',
                            fillOpacity: 0.1
                        };
                    }
                    
                    // Create GeoJSON layer with styling
                    const geoJsonLayer = L.geoJson(data, {
                        style: barangayStyle,
                        onEachFeature: function(feature, layer) {
                            if (feature.properties) {
                                let popupContent = '<div class="popup-content">';
                                for (const property in feature.properties) {
                                    popupContent += `<strong>${property}:</strong> ${feature.properties[property]}<br>`;
                                }
                                popupContent += '</div>';
                                layer.bindPopup(popupContent);
                            }
                        }
                    });
                    
                    progressElement.style.width = '90%';
                    
                    // Clear any existing layers
                    barangayLayer.clearLayers();
                    
                    // Add to barangay layer
                    geoJsonLayer.addTo(barangayLayer);
                    loadedLayers.barangays = geoJsonLayer;
                    
                    // Update status
                    statusElement.textContent = 'Loaded';
                    progressElement.style.width = '100%';
                    
                    // Hide warning after a short delay
                    setTimeout(() => {
                        warningElement.style.display = 'none';
                    }, 2000);
                    
                    // If checkbox is checked, add to map
                    if (document.getElementById('barangay-layer').checked) {
                        map.addLayer(barangayLayer);
                    }
                })
                .catch(function(error) {
                    handleGeoJSONError(error, 'barangay');
                    warningElement.style.display = 'none';
                });
        }
        
        // Add sample provinces for demonstration if the real data fails to load
        function addSampleProvinces() {
            // Sample provinces (just for demonstration)
            const provinces = [
                {
                    name: "La Union",
                    coords: [
                        [17.5, 120.2],
                        [17.5, 120.8],
                        [16.8, 120.8],
                        [16.8, 120.2]
                    ]
                },
                {
                    name: "Pangasinan",
                    coords: [
                        [16.8, 119.8],
                        [16.8, 120.5],
                        [15.8, 120.5],
                        [15.8, 119.8]
                    ]
                },
                {
                    name: "Bulacan",
                    coords: [
                        [15.2, 120.8],
                        [15.2, 121.3],
                        [14.7, 121.3],
                        [14.7, 120.8]
                    ]
                }
            ];
            
            // Clear any existing layers
            provinceLayer.clearLayers();
            
            // Add sample provinces
            provinces.forEach(province => {
                L.polygon(province.coords, {
                    color: '#cc0000',
                    weight: 2,
                    fillOpacity: 0.3
                }).bindPopup(province.name + ' Province (Sample Data)').addTo(provinceLayer);
            });
            
            // If checkbox is checked, add to map
            if (document.getElementById('province-layer').checked) {
                map.addLayer(provinceLayer);
            }
            
            document.getElementById('province-status').textContent = 'Sample data';
        }
        
        // Add sample municipalities for demonstration
        function addSampleMunicipalities() {
            // Sample municipalities (just for demonstration)
            const municipalities = [
                {
                    name: "San Fernando",
                    coords: [
                        [16.65, 120.35],
                        [16.65, 120.45],
                        [16.55, 120.45],
                        [16.55, 120.35]
                    ]
                },
                {
                    name: "Dagupan",
                    coords: [
                        [16.08, 120.38],
                        [16.08, 120.42],
                        [16.04, 120.42],
                        [16.04, 120.38]
                    ]
                }
            ];
            
            // Clear any existing layers
            municipalityLayer.clearLayers();
            
            // Add sample municipalities
            municipalities.forEach(municipality => {
                L.polygon(municipality.coords, {
                    color: '#ff4500',
                    weight: 1,
                    fillOpacity: 0.2
                }).bindPopup(municipality.name + ' Municipality (Sample Data)').addTo(municipalityLayer);
            });
            
            // If checkbox is checked, add to map
            if (document.getElementById('municipality-layer').checked) {
                map.addLayer(municipalityLayer);
            }
            
            document.getElementById('municipality-status').textContent = 'Sample data';
        }
        
        // Add sample barangays for demonstration
        function addSampleBarangays() {
            // Sample barangays (just for demonstration)
            const barangays = [
                {
                    name: "Barangay 1",
                    coords: [
                        [16.62, 120.37],
                        [16.62, 120.38],
                        [16.61, 120.38],
                        [16.61, 120.37]
                    ]
                },
                {
                    name: "Barangay 2",
                    coords: [
                        [16.06, 120.39],
                        [16.06, 120.40],
                        [16.05, 120.40],
                        [16.05, 120.39]
                    ]
                }
            ];
            
            // Clear any existing layers
            barangayLayer.clearLayers();
            
            // Add sample barangays
            barangays.forEach(barangay => {
                L.polygon(barangay.coords, {
                    color: '#ff6b6b',
                    weight: 0.5,
                    fillOpacity: 0.1
                }).bindPopup(barangay.name + ' Barangay (Sample Data)').addTo(barangayLayer);
            });
            
            // If checkbox is checked, add to map
            if (document.getElementById('barangay-layer').checked) {
                map.addLayer(barangayLayer);
            }
            
            document.getElementById('barangay-status').textContent = 'Sample data';
        }
        
        // Add sample region (just for demonstration)
        function addSampleRegion() {
            const region = L.polygon([
                [18.5, 120],
                [18.5, 122],
                [16.5, 122],
                [16.5, 120]
            ], {
                color: '#8b0000',
                weight: 2,
                fillOpacity: 0.1
            }).bindPopup('Ilocos Region (Sample Data)').addTo(regionLayer);
        }
        
        // Call the function to load boundaries
        loadProvinces();
        addSampleRegion();
        
        // Set up layer control
        const overlayMaps = {
            "Regions": regionLayer,
            "Provinces": provinceLayer,
            "Municipalities": municipalityLayer,
            "Barangays": barangayLayer
        };
        
        L.control.layers(basemaps, overlayMaps, {
            position: 'topright',
            collapsed: false
        }).addTo(map);
        
        // Panel toggle functionality
        document.querySelectorAll('.panel-header').forEach(header => {
            header.addEventListener('click', () => {
                const panel = header.parentElement;
                panel.classList.toggle('active');
            });
        });
        
        // Layer toggle functionality
        document.getElementById('region-layer').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.addLayer(regionLayer);
            } else {
                map.removeLayer(regionLayer);
            }
        });
        
        document.getElementById('province-layer').addEventListener('change', (e) => {
            if (e.target.checked) {
                // If provinces haven't loaded successfully, try to load them
                if (!loadedLayers.provinces) {
                    loadProvinces();
                } else {
                    map.addLayer(provinceLayer);
                }
            } else {
                map.removeLayer(provinceLayer);
            }
        });
        
        document.getElementById('municipality-layer').addEventListener('change', (e) => {
            if (e.target.checked) {
                // Load municipalities if not already loaded
                if (!loadedLayers.municipalities) {
                    loadMunicipalities();
                } else {
                    map.addLayer(municipalityLayer);
                }
            } else {
                map.removeLayer(municipalityLayer);
            }
        });
        
        document.getElementById('barangay-layer').addEventListener('change', (e) => {
            if (e.target.checked) {
                // Load barangays if not already loaded
                if (!loadedLayers.barangays) {
                    loadBarangays();
                } else {
                    map.addLayer(barangayLayer);
                }
            } else {
                map.removeLayer(barangayLayer);
            }
        });
        
        // Sidebar toggle functionality
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            
            if (sidebar.style.transform === 'translateX(-350px)') {
                sidebar.style.transform = 'translateX(0)';
                toggleBtn.style.left = '350px';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            } else {
                sidebar.style.transform = 'translateX(-350px)';
                toggleBtn.style.left = '0';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
        });
        
        // Basemap selector functionality
        document.getElementById('basemap-select').addEventListener('change', (e) => {
            // Remove all basemaps
            Object.values(basemaps).forEach(layer => {
                map.removeLayer(layer);
            });
            
            // Add the selected basemap
            basemaps[e.target.value].addTo(map);
        });
        
        // Upload button functionality
        document.getElementById('upload-btn').addEventListener('click', () => {
            const uploadPanel = document.getElementById('upload-panel');
            if (uploadPanel.style.display === 'block') {
                uploadPanel.style.display = 'none';
            } else {
                uploadPanel.style.display = 'block';
            }
        });
        
        // Close upload panel when clicking outside
        document.addEventListener('click', (e) => {
            const uploadPanel = document.getElementById('upload-panel');
            const uploadBtn = document.getElementById('upload-btn');
            
            if (uploadPanel.style.display === 'block' && 
                !uploadPanel.contains(e.target) && 
                e.target !== uploadBtn) {
                uploadPanel.style.display = 'none';
            }
        });
        
        // Slider functionality
        document.getElementById('year-slider').addEventListener('input', (e) => {
            document.getElementById('year-value').textContent = e.target.value;
        });
        
        document.getElementById('timeline-slider').addEventListener('input', (e) => {
            document.getElementById('timeline-year').textContent = e.target.value;
        });
        
        document.getElementById('opacity-slider').addEventListener('input', (e) => {
            document.getElementById('opacity-value').textContent = e.target.value;
            
            // Update layer opacities
            if (loadedLayers.provinces) {
                loadedLayers.provinces.setStyle({
                    fillOpacity: e.target.value / 100 * 0.3
                });
            }
            
            if (loadedLayers.municipalities) {
                loadedLayers.municipalities.setStyle({
                    fillOpacity: e.target.value / 100 * 0.2
                });
            }
            
            if (loadedLayers.barangays) {
                loadedLayers.barangays.setStyle({
                    fillOpacity: e.target.value / 100 * 0.1
                });
            }
        });
        
        // Add click event to show info panel
        map.on('click', (e) => {
            const infoPanel = document.getElementById('info-panel');
            infoPanel.innerHTML = `
                <h4>Location Information</h4>
                <p><strong>Latitude:</strong> ${e.latlng.lat.toFixed(4)}</p>
                <p><strong>Longitude:</strong> ${e.latlng.lng.toFixed(4)}</p>
            `;
            infoPanel.style.display = 'block';
        });
        
        // Close info panel when clicking on the map
        map.on('popupopen', () => {
            document.getElementById('info-panel').style.display = 'none';
        });
    </script>
</body>
</html>
